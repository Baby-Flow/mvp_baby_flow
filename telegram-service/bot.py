import os
import asyncio
import logging
import requests
from datetime import datetime
import pytz
from dotenv import load_dotenv
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, FSInputFile
from chart_generator import create_sleep_chart, create_feeding_chart, create_activity_summary_chart

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
NLP_SERVICE_URL = os.getenv("NLP_SERVICE_URL", "http://localhost:8002")
ACTIVITY_SERVICE_URL = os.getenv("ACTIVITY_SERVICE_URL", "http://localhost:8003")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–≤—è–∑–∏ telegram_id —Å user_id –∏ child_id
# –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –∏–ª–∏ –ë–î
user_mapping = {}


@dp.message(CommandStart())
async def start_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
    telegram_id = message.from_user.id
    first_name = message.from_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    username = message.from_user.username

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        response = requests.get(f"{ACTIVITY_SERVICE_URL}/users/telegram/{telegram_id}")
        if response.status_code == 404:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_data = {
                "telegram_id": telegram_id,
                "username": username,
                "first_name": first_name
            }
            response = requests.post(f"{ACTIVITY_SERVICE_URL}/users/", json=user_data)
            user = response.json()
            await message.answer(
                f"üëã –ü—Ä–∏–≤–µ—Ç, {first_name}!\n\n"
                "–Ø –ê–ª–∏—Å–∞ - –ø–æ–º–æ–≥—É –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫ —Ä–∞–∑–≤–∏—Ç–∏—è –≤–∞—à–µ–≥–æ –º–∞–ª—ã—à–∞.\n"
                "–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ –º–Ω–µ –æ–±—ã—á–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
                "‚Ä¢ —É—Å–Ω—É–ª\n"
                "‚Ä¢ –ø—Ä–æ—Å–Ω—É–ª—Å—è\n"
                "‚Ä¢ –ø–æ–∫–æ—Ä–º–∏–ª–∞ 200–º–ª\n"
                "‚Ä¢ –≥—É–ª—è–µ–º –≤ –ø–∞—Ä–∫–µ\n"
                "‚Ä¢ –≤—á–µ—Ä–∞ –≤–µ—á–µ—Ä–æ–º –ø–ª–æ—Ö–æ —Å–ø–∞–ª\n"
                "‚Ä¢ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –±—ã–ª–∞ 37.5 –ø–æ–∑–∞–≤—á–µ—Ä–∞\n\n"
                "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –º–∞–ª—ã—à–∞ –∫–æ–º–∞–Ω–¥–æ–π:\n"
                "/add_child –ò–º—è 2024-01-15"
            )
        else:
            user = response.json()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –¥–µ—Ç–∏
            children_response = requests.get(f"{ACTIVITY_SERVICE_URL}/children/user/{user['id']}")
            children = children_response.json()

            if children:
                child = children[0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞
                user_mapping[telegram_id] = {"user_id": user["id"], "child_id": child["id"]}
                await message.answer(
                    f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {first_name}!\n"
                    f"–ó–∞–ø–∏—Å—ã–≤–∞—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è: {child['name']}\n\n"
                    "–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –º–∞–ª—ã—à–æ–º."
                )
            else:
                await message.answer(
                    f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {first_name}!\n\n"
                    "–î–æ–±–∞–≤—å—Ç–µ —Ä–µ–±–µ–Ω–∫–∞ –∫–æ–º–∞–Ω–¥–æ–π:\n"
                    "/add_child –ò–º—è 2024-01-15"
                )
    except Exception as e:
        logger.error(f"Error in start_handler: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")


@dp.message(Command("add_child"))
async def add_child_handler(message: Message):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞"""
    telegram_id = message.from_user.id

    try:
        # –ü–æ–ª—É—á–∞–µ–º user_id
        response = requests.get(f"{ACTIVITY_SERVICE_URL}/users/telegram/{telegram_id}")
        if response.status_code == 404:
            await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ /start")
            return

        user = response.json()

        # –ü–∞—Ä—Å–∏–º –∫–æ–º–∞–Ω–¥—É
        parts = message.text.split()
        if len(parts) < 3:
            await message.answer(
                "–§–æ—Ä–º–∞—Ç: /add_child –ò–º—è –ì–ì–ì–ì-–ú–ú-–î–î\n"
                "–ü—Ä–∏–º–µ—Ä: /add_child –°–∞—à–∞ 2024-01-15"
            )
            return

        name = parts[1]
        birth_date = parts[2]

        # –°–æ–∑–¥–∞–µ–º —Ä–µ–±–µ–Ω–∫–∞
        child_data = {
            "user_id": user["id"],
            "name": name,
            "birth_date": birth_date
        }

        response = requests.post(f"{ACTIVITY_SERVICE_URL}/children/", json=child_data)
        if response.status_code == 200:
            child = response.json()
            user_mapping[telegram_id] = {"user_id": user["id"], "child_id": child["id"]}
            await message.answer(
                f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–±–µ–Ω–æ–∫: {name}\n"
                f"–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_date}\n\n"
                "–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!"
            )
        else:
            await message.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã.")
    except Exception as e:
        logger.error(f"Error in add_child: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.")


@dp.message(Command("today"))
async def today_handler(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è"""
    telegram_id = message.from_user.id

    if telegram_id not in user_mapping:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –º–∞–ª—ã—à–∞ —á–µ—Ä–µ–∑ /add_child")
        return

    child_id = user_mapping[telegram_id]["child_id"]

    try:
        response = requests.get(f"{ACTIVITY_SERVICE_URL}/activities/child/{child_id}/today")
        if response.status_code != 200:
            await message.answer("–ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ üôè")
            return

        data = response.json()
        text = "üìä *–°–µ–≥–æ–¥–Ω—è —É –º–∞–ª—ã—à–∞:*\n\n"

        # –°–æ–Ω
        if data.get("sleep"):
            text += "üò¥ *–°–æ–Ω:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            for sleep in data["sleep"]:
                start_dt = datetime.fromisoformat(sleep["start_time"].replace('Z', '+00:00'))
                start_moscow = start_dt.astimezone(moscow_tz)
                start = start_moscow.strftime("%H:%M")

                if sleep["end_time"]:
                    end_dt = datetime.fromisoformat(sleep["end_time"].replace('Z', '+00:00'))
                    end_moscow = end_dt.astimezone(moscow_tz)
                    end = end_moscow.strftime("%H:%M")
                    duration = sleep.get("duration_minutes", 0)
                    hours = duration // 60
                    minutes = duration % 60
                    if hours > 0:
                        duration_str = f"{hours}—á {minutes}–º–∏–Ω"
                    else:
                        duration_str = f"{minutes} –º–∏–Ω"
                    text += f"‚Ä¢ {start} - {end} ({duration_str})\n"
                else:
                    text += f"‚Ä¢ –°–ø–∏—Ç —Å {start} üí§\n"

        # –ö–æ—Ä–º–ª–µ–Ω–∏–µ
        if data.get("feeding"):
            text += "\nüçº *–ö–æ—Ä–º–ª–µ–Ω–∏—è:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            for feed in data["feeding"]:
                time_dt = datetime.fromisoformat(feed["time"].replace('Z', '+00:00'))
                time_moscow = time_dt.astimezone(moscow_tz)
                time = time_moscow.strftime("%H:%M")
                text += f"‚Ä¢ {time}"
                if feed.get("amount_ml"):
                    text += f" - {feed['amount_ml']}–º–ª"
                if feed.get("food_name"):
                    text += f" ({feed['food_name']})"
                text += "\n"

        # –ü—Ä–æ–≥—É–ª–∫–∏
        if data.get("walks"):
            text += "\nüö∂ *–ü—Ä–æ–≥—É–ª–∫–∏:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            for walk in data["walks"]:
                start_dt = datetime.fromisoformat(walk["start_time"].replace('Z', '+00:00'))
                start_moscow = start_dt.astimezone(moscow_tz)
                start = start_moscow.strftime("%H:%M")
                if walk["end_time"]:
                    end_dt = datetime.fromisoformat(walk["end_time"].replace('Z', '+00:00'))
                    end_moscow = end_dt.astimezone(moscow_tz)
                    end = end_moscow.strftime("%H:%M")
                    text += f"‚Ä¢ {start} - {end}"
                    if walk.get("location"):
                        text += f" ({walk['location']})"
                else:
                    text += f"‚Ä¢ –ì—É–ª—è–µ–º —Å {start} üå≥"
                text += "\n"

        # –ü–æ–¥–≥—É–∑–Ω–∏–∫–∏
        if data.get("diapers"):
            text += "\nüöº *–ü–æ–¥–≥—É–∑–Ω–∏–∫–∏:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            for diaper in data["diapers"]:
                time_dt = datetime.fromisoformat(diaper["time"].replace('Z', '+00:00'))
                time_moscow = time_dt.astimezone(moscow_tz)
                time = time_moscow.strftime("%H:%M")

                if diaper["type"] == "poop":
                    emoji = "üí©"
                elif diaper["type"] == "pee":
                    emoji = "üíß"
                else:
                    emoji = "üöº"

                text += f"‚Ä¢ {time} {emoji}"
                if diaper.get("consistency"):
                    text += f" ({diaper['consistency']})"
                text += "\n"

        # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
        if data.get("temperatures"):
            text += "\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            for temp in data["temperatures"]:
                time_dt = datetime.fromisoformat(temp["time"].replace('Z', '+00:00'))
                time_moscow = time_dt.astimezone(moscow_tz)
                time = time_moscow.strftime("%H:%M")

                text += f"‚Ä¢ {time} - {temp['temperature']}¬∞C"
                if temp.get("measurement_type"):
                    text += f" ({temp['measurement_type']})"
                text += "\n"

        # –õ–µ–∫–∞—Ä—Å—Ç–≤–∞
        if data.get("medications"):
            text += "\nüíä *–õ–µ–∫–∞—Ä—Å—Ç–≤–∞:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            for med in data["medications"]:
                time_dt = datetime.fromisoformat(med["time"].replace('Z', '+00:00'))
                time_moscow = time_dt.astimezone(moscow_tz)
                time = time_moscow.strftime("%H:%M")

                text += f"‚Ä¢ {time} - {med['medication_name']}"
                if med.get("dosage"):
                    text += f" ({med['dosage']})"
                text += "\n"

        # –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        if data.get("moods"):
            text += "\nüòä *–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:*\n"
            moscow_tz = pytz.timezone('Europe/Moscow')
            mood_emojis = {
                "–≤–µ—Å–µ–ª–æ–µ": "üòÑ",
                "—Å–ø–æ–∫–æ–π–Ω–æ–µ": "üòå",
                "–∫–∞–ø—Ä–∏–∑–Ω–æ–µ": "üò§",
                "–ø–ª–∞—á–µ—Ç": "üò¢",
                "—Ö–æ—Ä–æ—à–µ–µ": "üòä",
                "–ø–ª–æ—Ö–æ–µ": "üòî"
            }
            for mood_entry in data["moods"]:
                time_dt = datetime.fromisoformat(mood_entry["time"].replace('Z', '+00:00'))
                time_moscow = time_dt.astimezone(moscow_tz)
                time = time_moscow.strftime("%H:%M")

                mood = mood_entry["mood"]
                emoji = mood_emojis.get(mood.lower(), "üòä")
                text += f"‚Ä¢ {time} - {emoji} {mood}"
                if mood_entry.get("notes"):
                    text += f" ({mood_entry['notes']})"
                text += "\n"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –∑–∞–ø–∏—Å–∏
        if not any([data.get("sleep"), data.get("feeding"), data.get("walks"),
                    data.get("diapers"), data.get("temperatures"),
                    data.get("medications"), data.get("moods")]):
            text = "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∞–ª—ã—à? üòä"

        await message.answer(text, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"Error in today_handler: {e}")
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòî")


@dp.message(Command("stats"))
async def stats_handler(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –Ω–µ–¥–µ–ª—é"""
    telegram_id = message.from_user.id

    if telegram_id not in user_mapping:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –º–∞–ª—ã—à–∞ —á–µ—Ä–µ–∑ /add_child")
        return

    child_id = user_mapping[telegram_id]["child_id"]

    try:
        response = requests.get(f"{ACTIVITY_SERVICE_URL}/analytics/child/{child_id}/stats?days=7")
        if response.status_code != 200:
            await message.answer("–ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ üôè")
            return

        data = response.json()
        text = "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é:*\n\n"

        # –°–æ–Ω
        sleep = data["sleep"]
        text += f"üò¥ *–°–æ–Ω:*\n"
        text += f"‚Ä¢ –í—Å–µ–≥–æ: {sleep['count']} —Ä–∞–∑\n"
        text += f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {sleep['avg_duration_hours']} —á\n"
        text += f"‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: {sleep['total_duration_hours']} —á\n\n"

        # –ö–æ—Ä–º–ª–µ–Ω–∏–µ
        feeding = data["feeding"]
        text += f"üçº *–ö–æ—Ä–º–ª–µ–Ω–∏–µ:*\n"
        text += f"‚Ä¢ –í—Å–µ–≥–æ: {feeding['count']} —Ä–∞–∑\n"
        if feeding['avg_amount_ml'] > 0:
            text += f"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º: {int(feeding['avg_amount_ml'])} –º–ª\n"
            text += f"‚Ä¢ –û–±—â–∏–π –æ–±—ä–µ–º: {int(feeding['total_amount_ml'])} –º–ª\n"
        if feeding['by_type']:
            text += "‚Ä¢ –ü–æ —Ç–∏–ø–∞–º:\n"
            for ftype, count in feeding['by_type'].items():
                text += f"  - {ftype}: {count}\n"
        text += "\n"

        # –ü—Ä–æ–≥—É–ª–∫–∏
        walks = data["walks"]
        if walks['count'] > 0:
            text += f"üö∂ *–ü—Ä–æ–≥—É–ª–∫–∏:*\n"
            text += f"‚Ä¢ –í—Å–µ–≥–æ: {walks['count']} —Ä–∞–∑\n"
            text += f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {walks['avg_duration_hours']} —á\n\n"

        # –ü–æ–¥–≥—É–∑–Ω–∏–∫–∏
        diapers = data["diapers"]
        if diapers['count'] > 0:
            text += f"üöº *–ü–æ–¥–≥—É–∑–Ω–∏–∫–∏:*\n"
            text += f"‚Ä¢ –í—Å–µ–≥–æ: {diapers['count']} —Ä–∞–∑\n"
            if diapers['by_type']:
                for dtype, count in diapers['by_type'].items():
                    emoji = "üí©" if dtype == "poop" else "üíß" if dtype == "pee" else "üöº"
                    text += f"‚Ä¢ {emoji} {dtype}: {count}\n"
            text += "\n"

        # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
        temp = data["temperature"]
        if temp['count'] > 0:
            text += f"üå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:*\n"
            text += f"‚Ä¢ –ò–∑–º–µ—Ä–µ–Ω–∏–π: {temp['count']}\n"
            text += f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è: {temp['avg']:.1f}¬∞C\n"
            text += f"‚Ä¢ –ú–∏–Ω–∏–º—É–º: {temp['min']:.1f}¬∞C\n"
            text += f"‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: {temp['max']:.1f}¬∞C\n"

        await message.answer(text, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"Error in stats_handler: {e}")
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòî")


@dp.message(Command("week"))
async def week_handler(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–¥–µ–ª—é"""
    telegram_id = message.from_user.id

    if telegram_id not in user_mapping:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –º–∞–ª—ã—à–∞ —á–µ—Ä–µ–∑ /add_child")
        return

    child_id = user_mapping[telegram_id]["child_id"]

    try:
        response = requests.get(f"{ACTIVITY_SERVICE_URL}/analytics/child/{child_id}/daily?days=7")
        if response.status_code != 200:
            await message.answer("–ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ üôè")
            return

        daily_data = response.json()
        text = "üìÖ *–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–¥–µ–ª—é:*\n\n"

        for day in daily_data:
            from datetime import datetime
            date_obj = datetime.fromisoformat(day['date'])
            day_name = date_obj.strftime("%d.%m (%a)")

            text += f"*{day_name}:*\n"
            text += f"  üò¥ –°–æ–Ω: {day['sleep']['total_hours']}—á ({day['sleep']['count']} —Ä–∞–∑)\n"
            text += f"  üçº –ö–æ—Ä–º–ª–µ–Ω–∏–π: {day['feeding']['count']}"
            if day['feeding']['total_ml']:
                text += f" ({day['feeding']['total_ml']}–º–ª)"
            text += f"\n"
            text += f"  üöº –ü–æ–¥–≥—É–∑–Ω–∏–∫–æ–≤: {day['diapers']['count']}\n\n"

        await message.answer(text, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"Error in week_handler: {e}")
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ üòî")


@dp.message(Command("chart"))
async def chart_handler(message: Message):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    telegram_id = message.from_user.id

    if telegram_id not in user_mapping:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –º–∞–ª—ã—à–∞ —á–µ—Ä–µ–∑ /add_child")
        return

    child_id = user_mapping[telegram_id]["child_id"]

    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        stats_response = requests.get(f"{ACTIVITY_SERVICE_URL}/analytics/child/{child_id}/stats?days=7")
        daily_response = requests.get(f"{ACTIVITY_SERVICE_URL}/analytics/child/{child_id}/daily?days=7")

        if stats_response.status_code != 200 or daily_response.status_code != 200:
            await message.answer("–ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ üòî")
            return

        stats_data = stats_response.json()
        daily_data = daily_response.json()

        await message.answer("üìà –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≥—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")

        # –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        import tempfile
        import os

        # –ì—Ä–∞—Ñ–∏–∫ —Å–Ω–∞
        sleep_chart = create_sleep_chart(daily_data)
        with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as tmp_file:
            tmp_file.write(sleep_chart)
            sleep_chart_path = tmp_file.name

        # –ì—Ä–∞—Ñ–∏–∫ –∫–æ—Ä–º–ª–µ–Ω–∏–π
        feeding_chart = create_feeding_chart(daily_data)
        with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as tmp_file:
            tmp_file.write(feeding_chart)
            feeding_chart_path = tmp_file.name

        # –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        summary_chart = create_activity_summary_chart(stats_data)
        with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as tmp_file:
            tmp_file.write(summary_chart)
            summary_chart_path = tmp_file.name

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        await bot.send_photo(
            message.chat.id,
            FSInputFile(sleep_chart_path),
            caption="üò¥ –ì—Ä–∞—Ñ–∏–∫ —Å–Ω–∞ –∑–∞ –Ω–µ–¥–µ–ª—é"
        )

        await bot.send_photo(
            message.chat.id,
            FSInputFile(feeding_chart_path),
            caption="üçº –ì—Ä–∞—Ñ–∏–∫ –∫–æ—Ä–º–ª–µ–Ω–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é"
        )

        await bot.send_photo(
            message.chat.id,
            FSInputFile(summary_chart_path),
            caption="üìä –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é"
        )

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        os.unlink(sleep_chart_path)
        os.unlink(feeding_chart_path)
        os.unlink(summary_chart_path)

    except Exception as e:
        logger.error(f"Error in chart_handler: {e}")
        await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ üòî")


@dp.message(Command("help"))
async def help_handler(message: Message):
    """–ü–æ–º–æ—â—å"""
    help_text = """
*–Ø –ê–ª–∏—Å–∞, –≤–∞—à–∞ –ø–æ–º–æ—â–Ω–∏—Ü–∞* ü§±

*–ö–æ–º–∞–Ω–¥—ã:*
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/add_child - –¥–æ–±–∞–≤–∏—Ç—å –º–∞–ª—ã—à–∞
/today - —á—Ç–æ –±—ã–ª–æ —Å–µ–≥–æ–¥–Ω—è
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
/week - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
/chart - –≥—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
/help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

*–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:*
‚Ä¢ "—É—Å–Ω—É–ª" - –∑–∞–ø–∏—à—É –Ω–∞—á–∞–ª–æ —Å–Ω–∞
‚Ä¢ "–ø—Ä–æ—Å–Ω—É–ª—Å—è" - –æ—Ç–º–µ—á—É –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ
‚Ä¢ "–ø–æ–∫–æ—Ä–º–∏–ª–∞" - –∑–∞–ø–∏—à—É –∫–æ—Ä–º–ª–µ–Ω–∏–µ
‚Ä¢ "–≥—É–ª—è–µ–º" - –æ—Ç–º–µ—á—É –ø—Ä–æ–≥—É–ª–∫—É
‚Ä¢ "–ø–æ–∫–∞–∫–∞–ª" - –∑–∞–ø–∏—à—É —Å–º–µ–Ω—É –ø–æ–¥–≥—É–∑–Ω–∏–∫–∞
‚Ä¢ "–ø–æ–ø–∏—Å–∞–ª" - –æ—Ç–º–µ—á—É –º–æ–∫—Ä—ã–π –ø–æ–¥–≥—É–∑–Ω–∏–∫
‚Ä¢ "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 37.2" - –∑–∞–ø–∏—à—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
‚Ä¢ "–¥–∞–ª–∏ –Ω—É—Ä–æ—Ñ–µ–Ω 5–º–ª" - –∑–∞–ø–∏—à—É –ª–µ–∫–∞—Ä—Å—Ç–≤–æ
‚Ä¢ "–≤–µ—Å–µ–ª—ã–π" –∏–ª–∏ "–∫–∞–ø—Ä–∏–∑–Ω–∏—á–∞–µ—Ç" - –æ—Ç–º–µ—á—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ

*–ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:*
‚Ä¢ —Å–ø–∏—Ç —Å 14:30
‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ—Å–Ω—É–ª—Å—è
‚Ä¢ –ø–æ–∫–æ—Ä–º–∏–ª–∞ –≥—Ä—É–¥—å—é
‚Ä¢ –≤—ã–ø–∏–ª 200–º–ª —Å–º–µ—Å–∏
‚Ä¢ –≥—É–ª—è–µ–º –≤ –ø–∞—Ä–∫–µ
‚Ä¢ –≤—á–µ—Ä–∞ –≤–µ—á–µ—Ä–æ–º –ø–ª–æ—Ö–æ —Å–ø–∞–ª
‚Ä¢ –ø–æ–∑–∞–≤—á–µ—Ä–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –±—ã–ª–∞ 37.5
‚Ä¢ –ø–æ–∫–æ—Ä–º–∏–ª–∞ —á–µ—Ä–µ–∑ —á–∞—Å –ø–æ—Å–ª–µ —Å–Ω–∞
‚Ä¢ –≤ –æ–±–µ–¥ –ø–æ–∫–∞–∫–∞–ª

–Ø –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º –∏ –ø–æ–º–æ–≥—É! üíï
"""
    await message.answer(help_text, parse_mode="Markdown")


@dp.message()
async def message_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    telegram_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –º–∞–ø–ø–∏–Ω–≥–µ
    if telegram_id not in user_mapping:
        # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –ë–î
        try:
            response = requests.get(f"{ACTIVITY_SERVICE_URL}/users/telegram/{telegram_id}")
            if response.status_code == 200:
                user = response.json()
                children_response = requests.get(f"{ACTIVITY_SERVICE_URL}/children/user/{user['id']}")
                children = children_response.json()
                if children:
                    child = children[0]
                    user_mapping[telegram_id] = {"user_id": user["id"], "child_id": child["id"]}
                else:
                    await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–µ–±–µ–Ω–∫–∞ —á–µ—Ä–µ–∑ /add_child")
                    return
            else:
                await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start")
                return
        except:
            await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /start")
            return

    child_id = user_mapping[telegram_id]["child_id"]

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ NLP service
    try:
        nlp_data = {
            "message": message.text,
            "child_id": child_id,
            "user_id": user_mapping[telegram_id]["user_id"],
            "telegram_chat_id": message.chat.id
        }

        response = requests.post(f"{NLP_SERVICE_URL}/process", json=nlp_data)

        if response.status_code == 200:
            result = response.json()
            if result.get("success"):
                await message.answer(result["response"])
            else:
                await message.answer(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å: {result.get('response', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}")
        else:
            await message.answer("–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    except Exception as e:
        logger.error(f"Error in message_handler: {e}")
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è")


async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    logger.info("Starting bot...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())